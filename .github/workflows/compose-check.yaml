name: Check compose file

on:
  push:
    branches: [main]
    # paths:
    #   - services/**
  pull_request:
    branches: [main]
    # paths:
    #   - services/**
  workflow_dispatch:

env:
  # Home Assistant
  HOME_ASSISTANT_VOLUME: ${{ secrets.HOME_ASSISTANT_VOLUME }}\

  # Homebridge
  HOMEBRIDGE_VOLUME: ${{ secrets.HOMEBRIDGE_VOLUME }}

  # Scrypted
  SCRYPTED_TOKEN: ${{ secrets.SCRYPTED_TOKEN }}
  SCRYPTED_VOLUME: ${{ secrets.SCRYPTED_VOLUME }}

  # UpSnap
  UPSNAP_VOLUME: ${{ secrets.UPSNAP_VOLUME }}

jobs:
  check_syntax:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        uses: docker/setup-buildx-action@v3

      - name: Find Compose Files
        id: find_compose
        run: |
          find ./services -type f -name "compose.yaml" | while read -r file; do
            echo "::set-output name=files::$file"
          done

      - name: Check Compose Syntax
        run: |
          set -e
          files="${{ steps.find_compose.outputs.files }}"
          if [ -z "$files" ]; then
            echo "No compose.yaml files found."
            exit 0
          fi
          IFS=$'\n'
          for file in $files; do
            echo "Checking syntax for $file"
            docker compose -f "$file" config --quiet
            echo "Syntax OK for $file"
          done
